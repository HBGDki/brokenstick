---
title: "Getting started"
author: "Stef van Buuren"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Overview

The *broken stick model* describes a set of individual curves by a linear mixed model using first order linear B-splines. The model can be used

- to smooth growth curves by a series of connected straight lines;
- to align irregularly observed curves to a common age grid;
- to create synthetic curves at a user-specified set of break ages;
- to estimate the time-to-time correlation matrix;
- to predict future observations.

The user specifies a set of break ages at which the straight lines connect. Each individual obtains an estimate at each break age, so the set of estimates of the individual form a smoothed version of the observed trajectory. 

The main assumptions of the broken stick model are: 

- The development between the break ages follows a straight line, and is generally not of particular interest;
- Broken stick estimates follow a common multivariate normal distribution;

In order to conform to the assumption of multivariate normality, the user may fit the broken stick model on suitably transformed data that yield the standard normal ($Z$) scale. Unique feature of the broken stick model are:

- *Modular*: Issues related to nonlinearities of the growth curves in the observed scale can be treated separately, i.e., outside the broken stick model;
- *Local*: A given data point will contribute only to the estimates corresponding to the closest break ages;
- *Exportable*: The broken stick model can be exported and reused for prediction for new data in alternative computing environments.

The `brokenstick` package contains functions for

- Fitting the broken stick model to data, 
- Exporting the parameters of the model for independent use outside this package,
- Predicting broken stick estimates for new data.

## Main functions

The main functions in the `brokenstick` package are:

Function name        | Description
---------------------|---------------------------------
`brokenstick()`      | Fit a broken stick model to irregular data
`conditional.means()`| Obtain broken stick estimates from a fitted object
`EB()`               | Empirical Bayes predictor for random effects
`predict()`          | Predict broken stick estimates for new growth data
`export.brokenstick()` | Export broken stick model parameters 

## Exporatory analysis

```{R}
library("brokenstick")
data <- smocc.hgtwgt
head(data)
```

Plots of the first the height trajectories of two children can be made with the `lattice` function `xyplot()`, as follows:

```{R fig.width = 6}
library(lattice)
xyplot(hgt ~ age | id, data = data, 
	   subset = id %in% c(10001, 10005), 
	   type = "b", pch = 19, as.table = TRUE)
```

The plots gain more resolution when the Standard Deviation Scores (SDS) (or $Z$-values) are plotted. The column `hgt.z` contains the $Z$-scores of height relative to the WHO standard.

```{R fig.width = 6}
xyplot(hgt.z ~ age | id, data = data, 
	   subset = id %in% c(10001, 10005), 
	   type = "b", pch = 19, as.table = TRUE,
	   panel = function(...) {
	   	panel.refline(h = c(-2, 0, 2))
	   	panel.xyplot(...)
	   }
)
```


## Model with two lines

The *broken stick model* attempts to describe each trajectory by a series of straight but connected lines. Let us first do a rough approximation in the above figure. We specify that we may only use two lines: One line should start at birth to the age of exactly 1 years, and another spans the period from 1 to 2 years. Moreover, we require that the lines connect at the age of 1 year. 

```{r}
fit1 <- brokenstick(y = data$hgt.z, 
					x = data$age,
					subject = data$id,
					knots = 0:2)
```

The `knots` argument to `brokenstick()` specifies that the break ages are birth, 1 year and 2 years, respectively. The broken stick model effectively replaces the intercept by the random effects `x1`, `x2`, `x3` and `x4`. The
specified random effects correspond to break ages of 0, 1 and 2 and 3 years, respectively. The break age of 3 years is specified implicitely as a `Boundary.knot[2]`. This is done for technical reasons since the B-splines must encompass the entire age range in the data for it to have a useful interpretation. No intercept is needed since every row in the predictors adds up to one.

```{r}
class(fit1)
fit1@knots
summary(fit1)
```

The `fit1` object has S4 class `brokenstick`. The knots used in the model 
are stored in the slot called `fit1@knots`. The `summary()` function 
return the model estimates.

The fixed effects correspond to the mean of population of children in the data. At birth, the children are on average 0.1 SD taller than the WHO standard. At the ages of 1 and 2 years, these estimates rise to 0.38 SD and 0.52 SD, respectively. The fact that these are positive and rising is not surpring for this population. It is known that the Dutch are the tallest in the world. Evidently, already at the age of 2 years, the Dutch are about 0.5 SD taller than the WHO standard. Note that the estimate for `x4` (0.96), corresponding to the maximum age in the data, is just there for technical reasons. It is based on extreme extrapolation beyond the data, and should be disregarded.

The column labeled `Std.Dev.` contains the standard deviations of the random effects. These numbers are expected to be around 1, since - under the assumption that the WHO standard appropriately describes this population - the dependent variable follow a standard normal distribution with zero mean and standard deviation equal to one. The `cor` component of the output lists the correlations between the time point. Thus, the correlation between birth length and length at 2 years is about 0.58. 

Finally, the residual (0.49) is the standard deviation of the residual of the model. 


## Conditional means

A next step is to calculate the conditional means of the posterior distribution 
of the sum of fixed and random effects.

```{r}
est <- conditional.means(fit1)
head(est)
```

The broken stick estimates produced by `conditional.means()` can be found in the column called `yhat`. 

We concatenate the estimates to the data, and plot the original data and the broken stick estimates jointly by `xyplot()` as

```{r fig.width = 6}
library("dplyr")
colnames(est)[length(colnames(est))] <- "hgt.z"
est <- data.frame(est, src = "smocc", bse = TRUE)
data2 <- bind_rows(data.frame(data, bse = FALSE), est)

xyplot(hgt.z ~ age | id, data = data2,
       groups = bse, 
	     subset = id %in% c(10001, 10005) & age <= 2.3, 
	   type = "b", pch = 19, as.table = TRUE,
	   panel = function(...) {
	   	panel.refline(h = c(-2, 0, 2))
	   	panel.refline(v = 0:2, col = "firebrick1", lwd = 0.5, lty = 2)
	   	panel.xyplot(...)
	   }
)
```

## Extension to three lines

Suppose we are interest in refining the fit to the growth pattern during the first year. We may add an extra knots, say at 5 months. The three-line model can be run as    

```{r}
knots <- c(0, 5/12, 1, 2)
fit2 <- brokenstick(y = data$hgt.z, 
					x = data$age,
					subject = data$id,
					knots = knots)
```


```{r echo=FALSE, fig.width = 6}
est <- conditional.means(fit2)
colnames(est)[length(colnames(est))] <- "hgt.z"
est <- data.frame(est, src = "smocc", bse = TRUE)
data2 <- bind_rows(data.frame(data, bse = FALSE), est)

xyplot(hgt.z ~ age | id, data = data2,
       groups = bse, 
	     subset = id %in% c(10001, 10005) & age <= 2.3, 
	   type = "b", pch = 19, as.table = TRUE,
	   panel = function(...) {
	   	panel.refline(h = c(-2, 0, 2))
	   	panel.refline(v = knots, col = "firebrick1", lwd = 0.5, lty = 2)
	   	panel.xyplot(...)
	   }
)
```

Evidently, more knots can be added to improve the fit to the data. However, adding many knots to sparse data will substantially increase calculation time, and result in instable solutions. In general, one should not add more knots than the (average) number of data points per person.

## Explained variance

The proportion of the variance of the outcome explained by the two-line model is

```{R}
var(fitted(fit1)) / var(data$hgt.z)
```

For the three-line model, we get

```{R}
var(fitted(fit2)) / var(data$hgt.z)
```

## Export the model

The `fit1` object can be stored by `save()` for future use in R. However, a more parsimonious and convenient way to reuse the model is to export its parameter estimates, and store only these. As a matter of fact, prediction using the broken stick model requires only the knot locations, the fixed effect estimates, the variance/covariance matrix of the random effects, and the size of the residual variance. The `export.brokenstick()` function will collect this information from the fitted model.

```{R}
# export the broken stick models
export.hgt <- export.brokenstick(fit1)
export.hgt
```


## Predictions on new data

Prediction on new data can be obtained by the `predict()` function. The function requires a vector of measurements `y`, a vector measurement ages `age`, and the fitted model. 

The following lines repredict the broken stick estimates for subject 10001 using the three-lines model.

```{r}
# repredict first observation using three-line model
d <- data[data$id == "10001", c("age","hgt.z")]
predict(fit2, y = d$hgt.z, age = d$age)
```

As expected, the predicted values are identical to the estimates given before. 

We may now experiment with new data. For example, 
what is the prediction if our 
subject has a measurement of "+1", "0", "-1" at each break age?

```{r}
# trajectory at +1 and at -1
predict(fit2, y = rep(1, 4), age = c(0, 1/2, 1, 2))
predict(fit2, y = rep(0, 4), age = c(0, 1/2, 1, 2))
predict(fit2, y = rep(-1, 4), age = c(0, 1/2, 1, 2))
```

The estimates hoover around the measured value. As before, ignore that last predicted value that is on the boundary of the data range. Observe that the results are not symmetric because the fixed effect are non-zero. The predicted values shrink show the tendency to shrink towards the mean, i.e., towards the fixed effect estimates `r round(lme4::fixef(fit2), 2)`.

What will be predicted if we have only the first measurement taken at birth?

```{r}
# trajectory at +1 and at -1, but only at birth
predict(fit2, y = 1, age = 0)
predict(fit2, y = -1, age = 0)
```

As expected, the predicted values again shrink towards the mean, but now considerably more so. 


