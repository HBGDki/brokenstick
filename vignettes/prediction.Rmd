---
title: "Fit and predict"
author: "Stef van Buuren"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fit and predict}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 3.5)
```


## Objective

This vignette shows a step-by-step introduction of how to 
- Fit the broken stick model to data;
- Predict observations by the fitted model; 
- Validate predictions against a holdout sample.

## Get the data

This vignette assumes the `rbokeh`, `hbgd` and `brokenstick` packages are installed. See [getting started with `brokenstick`](gettingstarted.html) for the installation procedure.
We will use the `smocc_hgtwgt` demo data that is built-in into the `brokenstick` package. For computational efficiency in this vignette, we take the first 2000 observations of the `smocc_hgtwgt` data. 

```{r data}
require("brokenstick")
require("hbgd")
require("rbokeh")
smc <- smocc_hgtwgt[1:2000,]
```

## Calculate $Z$-scores

The broken stick model can fit observations in either the raw scale (cm, kg, and so on) or as a standard deviation score (SDS), or $Z$-score. The results from the analysis of the $Z$-score will often be better for two reasons: 1) for growth curves, a straight line assumption is more plausible in the $Z$-score scale, and 2) the assumption of normality is more plausible in the $Z$-score scale. It is easy to convert the measurements into the $Z$-score scale, fit the model, and convert back to the raw scale afterwards, if desired. The `hbgd` package contains several functions to convert back and forth between both scales. For example, 

```{r zscores}
haz <- who_htcm2zscore(smc$agedays, smc$htcm, smc$sex)
```

The main outcome measure will be `haz`, the age and sex-adjusted $Z$-score relative to the WHO growth standard. The inverse calculation can be done as

```{r}
htcm <- who_zscore2htcm(smc$agedays, haz, smc$sex)
```

Note that slight differences between `smc$htcm` and `htcm` may occur because of rounding, but the deviations are small and irrelevant.

```{r echo=FALSE}
plot_univar(smc, subject = FALSE, width = 220, height = 220)
```

The mean $Z$-score is around 0.3, indicating that Dutch children under two years are taller than the WHO height standard.

The age range is 0-2 years. The scatterplot of height SDS by age clearly shows the pattern in the visits.

```{r}
figure(xlab = "Age (years)", ylab = get_label("haz")) %>%
  ly_zband(x = seq(0, 2.5, 0.5), z = -c(2.5,2,1,0)) %>%
  ly_points(smc$age, smc$haz, hover = c(smc$age, smc$htcm), size = 4)
```

Note that the data contain some outliers. Child 10069 was born after a gestational age of 34 weeks and has several extremely low SDS values. Child 10075 had an observation at the age of 2.67 years.

The plot of the number of visits per child reveals that most children had 10 visits. It appears that children with fewer than six visits were removed from the data. Two children had more than 10 visits.  

```{r}
plot_visit_distn(smc, width = 350, height = 350)
```

The missing data plot shows that number of missing values in the time varying variables was very low. 

```{r}
plot_missing(smc, width = 600, height = 400)
```


## Define the knots

The SMOCC study had 10 scheduled visits: at birth, and at ages of 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. Here, we place the knots at the scheduled ages. Depending on the scientific question at hand, we could place knots at other locations. See the vignette on [knot placement](knotplacement.html) for more details. 

```{r}
knots <- round(c(0, 1, 2, 3, 6, 9, 12, 15, 18, 24)/12, 4)
boundary <- c(0, 3)
```


## Fit the model

The `brokenstick` function performs the actual model fitting. 

```{r cache = TRUE}
fit <- brokenstick(y = smc$haz,
                   x = smc$age,
                   subjid = smc$subjid,
                   knots = knots,
                   boundary = boundary)
```

It frequently happens that the fitting algorithm issues warnings about the number of random effect (too high), or reports that one of the random effects is deleted before fitting. This may or nay not affect the quality of the predictions. At the least, the user should check the fitted object for plausibilty. The current version uses the general purpose methods from the `lme4` package. Future versions of the `brokenstick` package may feature dedicated and stabler fitting methods.

The fitted object `fit` is of S4 class `brokenstick`, and extends class `lmerMod` with additional attributes `knots`, `boundary` and `degree`. The `brokenstick()` function only supports `degree = 1`, the straight line model.

## Interpret the model

Let us first extract the fixed effects and the corresponding knot locations.

```{r}
round(lme4::fixef(fit), 2)
round(get_knots(fit), 2)
```

The fixed effects correspond to the mean of sample of children in the data. The mean development over all 206 children may be plotted as:

```{r}
figure(xlab = "Age (years)", ylab = get_label("haz"), title = "Mean trajectory (n = 206)") %>%
  ly_zband(x = seq(0, 2.5, 0.5), z = -c(2.5,2,1,0)) %>%
  ly_points(get_knots(fit), lme4::fixef(fit), hover = c(get_knots(fit), lme4::fixef(fit))) %>%
  ly_lines(get_knots(fit), lme4::fixef(fit))
```

At birth, the 206 children are on average 0.64 SD taller than the WHO standard, but at the ages of month 1-3, the mean rapidly falls near or below the mean of the WHO standard. After that, there is a the trajectory consistently is above the mean, with values around 0.3-0.6 SDS. The fact that these are positive is not surprising as the Dutch are known to be among the tallest populations in the world. Thus, at the age of 2 years, the Dutch are about 0.5-0.6 SD taller than the WHO standard. The estimate for `x11` (0.56), corresponding to the age of 3 years is just there for technical reasons. The estimate is based on extreme extrapolation beyond the data. The last knot of the broken stick model has no interpretation, and should be disregarded.

```{r}
fit
```

The column labeled `Std.Dev.` contains the standard deviations of the random effects. These numbers are expected to be around 1, since - under the assumption that the WHO standard appropriately describes this sample - the dependent variable follow a standard normal distribution with zero mean and standard deviation equal to one. The `Corr` component of the random effects lists the correlations between the broken stick estimates at different ages. The correlation matrix shows a typically pattern where the highest elements are close to the diagonal, and where off-diagonal elements decrease. The standard deviation of the residuals (within-person error) for this model is of 0.26, so on average, the discrepancy between observed and fitted trajectories is about one quarter of a standard deviation. At the age of 2 years, the standard deviation in height is about 32 mm, so on average the difference between the model and the observed data is about 8 mm, about twice the size of the technical error of measurement of a carefully conducted height measurement.

## Obtain predicted values, all children

The `predict()` function obtains predictions from the broken stick model. The function is extremely flexible, and allows for prediction of new subjects at arbitrary ages in a variety of output formats. The simplest call 

```{r}
p <- predict(fit)
head(p, 4)
```

produces the predicted value (in `yhat`) for each measured data point for all children used to fit the model in the `long` output format. The observed $Z$-score is stored in column called `y`, and the corresponding broken stick estimates are stored in the column called `yhat`. The column `knot` is set to `FALSE` if `y` is actually observed. 

The predicted values represent a compromise between the person's data values and the global mean. In general, the fewer and less extreme data points of a person are, the closer the compromise will be toward the global mean. The compromise is called the *conditional mean* of the posterior distribution. In the broken stick model, it is simply calculated as the sum of the fixed and random effects.

We can obtain the location at which the lines in the broken stick model connect by specifying the `at = "knots"` argument, e.g.

```{r}
p2 <- predict(fit, at = "knots")
head(p2, 4)
```

Note that the column `knot` is now `TRUE`. We may obtain both types of estimates simultaneously for all children by using the 

```{r}
pr <- predict(fit, at = "both")
head(pr, 4)
```

## Obtain predicted values, single child

We plot the original data and the broken stick estimates for child 10001 jointly as

```{r fig3}
plot(fit, ids = 10001, x_trim = c(0, 2.2))
```


### Prediction at break ages, single child

Let's take the first child in the data. Predicting the broken stick values at the break ages for this child can be done from the `fit` or `exp` object. Here we use `exp`:

```{r}
UID <- unique(smc$subjid)
cid <- UID[1]
d <- smc[smc$subjid == cid, ]
p <- predict(exp, y = d$haz, x = d$age, at = "knots")

plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Break ages, child", cid))
lines(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x, lty = 5, col = "grey80")
```

### Prediction at measurement ages, single child

Suppose we want a predicted value at each age at which the child was measured. 

```{r}
p <- predict(fit, y = d$haz, x = d$age)
```

```{r echo = FALSE}
plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Measurement ages, child", cid))
points(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = d$age, lty = 5, col = "grey80")
```


### Prediction at arbitrary ages, single child

Suppose we want the predicted value at the ages of 0.5, 14 and 17 months exactly. For this, we need to pad the observations of child `r cid` with new ages and with missing outcomes.

```{r}
age <- c(d$age, c(0.5, 14, 17)/12)
y <- c(d$haz, c(NA, NA, NA))
p <- predict(exp, y = y, x = age)
```

```{r echo = FALSE}
plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Arbitrary ages, child", cid))
points(x = p$x[p$new], y = p$yhat[p$new], col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x[p$new], lty = 5, col = "grey80")
```


### Prediction of future trajectory, single child

Suppose that the child is six month old, and that we want to predict its future trajectory up to 2 years. What are the broken stick estimates at the break ages? 

```{r}
age <- d$age[1:5]
y <- d$haz[1:5]
p <- predict(exp, y = y, x = age, at = "knots")
```

```{r echo = FALSE}
plot(age, y, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Future trajectory, child", cid), xlim = c(0,2), ylim = c(0, 1.5))
lines(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x, lty = 5, col = "grey80")
```

## Predict values, all children in the model

A split and loop can be used to obtain the predicted values of all children in the test data, as follows:

```{r fig.height=7, fig.width=7}
# if we have access to the brokenstick object
p <- predict(fit)
dim(p)
head(p)

# case-by-case prediction on external data, 
ds <- split(smc, f = smc$subjid, drop = TRUE)
result <- vector("list", length(ds))

for (i in seq_along(ds)) {
  d <- ds[[i]]
  if (nrow(d) > 0) result[[i]] <- predict(exp, y = d$haz, x = d$age, 
                                          output = "vector", 
                                          include.boundaries = TRUE)
}
smc$yhat <- unlist(result)
head(smc)

# do we get same answers?
all.equal(smc$yhat, p$yhat)
```

The scatterplot of the observed versus predicted values indicates an extremely accurate prediction. The correlation is to `r round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`. 

```{r}
library("MASS")
eqscplot(y = smc$yhat, x = smc$haz, ylab = "Predicted Z-score", xlab = "Observed Z-score", pch = ".", main = "Children in the model")
abline(0, 1, col = "grey")
```


## Convert to original scale

All modeling has been done in the Z-score scale. If we want the result in the original scale, we can convert the estimates using the WHO reference, as follows:

```{r}
# convert Z-score to CM
smc$yhatcm <- who_zscore2htcm(smc$agedays, smc$yhat, smc$sex)
```

The plot of the observed versus predicted is now considerably tighter, and the overall fit appears to be quite high. The correlation between the observed and predicted scores using the raw scale is equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 3)`, which is very small. 

```{r echo = FALSE}
eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Children in the model")
abline(0, 1, col = "grey")
```

## Application to holdout sample

The `smocc_hgtwgt` data has `r nrow(smocc_hgtwgt)` rows, but until now we've used only the first 2000 rows. Is prediction equally good if we apply our fitted model and exported model in `exp` to the remaining rows, that is, to observations that were not part of the model fitting?

```{r echo = FALSE}
smc <- smocc_hgtwgt[-(1:2000), ]
smc$haz <- round(who_htcm2zscore(smc$agedays, smc$htcm, smc$sex), 3)

ds <- split(smc, f = smc$subjid, drop = TRUE)
result <- vector("list", length(ds))

for (i in seq_along(ds)) {
  d <- ds[[i]]
  if (nrow(d) > 0) result[[i]] <- predict(exp, y = d$haz, x = d$age, 
                                          output = "vector", 
                                          include.boundaries = TRUE)
}
smc$yhat <- unlist(result)
```

The figure below is the scatterplot of the observed versus predicted values for the holdout sample in the Z-score scale. The correlation is to `r round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`.

```{r echo=FALSE}
eqscplot(y = smc$yhat, x = smc$haz, pch = ".", ylab = "Predicted Z-score", xlab = "Observed Z-score", main = "Holdout sample")
abline(0, 1, col = "grey")
```


```{r echo = FALSE}
# convert Z-score to CM
smc$yhatcm <- who_zscore2htcm(smc$agedays, smc$yhat, smc$sex)
```

In terms of the raw meassurement scale we find a correlation between the observed and predicted scores equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 4)`, about the size of the measurement error for height.

The plot for the holdout sample is given below.

```{r echo = FALSE}
eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Holdout sample")
abline(0, 1, col = "grey")
```


## Export estimates

For easy handling and storage accross sessions, the `export()` function selects from `fit` the minimal set of estimates  needed to make predictions, and stores the results in an S3 class `brokenstick.export`. 

```{r}
class(fit)
slotNames(fit)
exp <- export(fit)
names(exp)
```

