---
title: "Fit and predict"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fit and predict}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 7, fig.height = 5)
```

## Objective

This vignette shows how to fit the broken stick model to data, predict observations by the fitted model, and validate the predictions against a holdout sample.

## Data

### Data source

We will use the `smocc_hgtwgt` demo data that is built-in into the `brokenstick` package. For computational efficiency in this vignette, we take the first 2000 observations of the `smocc_hgtwgt` data. 

```{r data}
library("brokenstick")
smc <- smocc_hgtwgt[1:2000,]
head(smc)
```

### Calculate Z-scores

The broken stick model can fit observations in either the raw scale (cm, kg, and so on) or in the Z-score scale. As the results from the analysis of the $Z$-score will often be **much better**, we advise to convert the measurements into the **Z-score scale**, fit the mode, and convert back to the raw scale afterwards when needed. Use the `AGD` package (from CRAN) or the `hbgd` package to convert back and forth between both scales. 

```{r zscores}
if (!require(hbgd)) devtools::install_github("hafen/hbgd")
smc$haz <- round(who_htcm2zscore(smc$agedays, smc$htcm, smc$sex), 3)
```

The main outcome measure will be `smc$haz`, the age and sex-adjusted Z-score relative to the WHO growth standard.

```{r echo=FALSE}
hist(smc$haz, main = "SMOCC data, first 2000 records", 
     xlab = "Height (Z-score)")
```

The mean Z-score is around 0.3, indicating that Dutch children are taller than the WHO height standard. 

The age range is 0-2 years. The scatterplot of Height SDS by age clearly shows the pattern in the visits.

```{r echo = FALSE}
plot(x = smc$age, y = smc$haz, xlab = "Age (in years)", ylab = "Height SDS", main = "SMOCC data, first 2000 records", pch = 20, cex = 0.5) 
```


## Fit model

### Define knots

The SMOCC data has 10 scheduled visits: at birth, and at ages of 1, 2, 3, 6, 9, 12, 15, 18 and 24 months. Here, we place the knots at the scheduled ages. Depending on the scientific question at hand, we could place knots at other locations. If we want to predict at specific ages, then specify knots at those ages. For example, if we are interested in predictions at 0.5, 1.0 and 2.0 years, define knots at those ages. In general, keep the number of knots low, for speed and simplicity. 

The `boundary` argument should be specified with some care. Specify the first break point `knot[1]` equal to `Boundary.knots[1]` and equal to the minumum age (otherwise unpredictable things occur). For technical reasons, `Boundary.knots[2]` should be equal to or larger than the maximum age in the data. The broken stick estimate at this knot has no useful interpretation.

```{r}
knots <- round(c(0, 1, 2, 3, 6, 9, 12, 15, 18, 24)/12, 4)
boundary <- c(0, 3)
```

## Model fitting

The `brokenstick` function performs the actual model fitting. The fitting algorithm may complain that the number of random effect is too high, but my experience is that this will not affect the quality of the predictions. 

```{r}
fit <- brokenstick(y = smc$haz,
                   x = smc$age,
                   subject = smc$subjid,
                   knots = knots,
                   boundary = boundary)
```

The fitted object `fit` is of S4 class `brokenstick`, and extends class `lmerMod` with additional attributes `knots`, `Boundary.knots`, `degree` and if `storeX = TRUE`, a slot called `fit@X`. 

### Export estimates

For easy handling and storage accross sessions, the `export()` function selects from `fit` the minimal set of estimates  needed to make predictions, and stores the results in an S3 class `brokenstick.export`. 

```{r}
class(fit)
slotNames(fit)
exp <- export(fit)
names(exp)
```

## Predict values, single child

### Prediction at break ages, single child

Let's take the first child in the data. Predicting the broken stick values at the break ages for this child can be done from the `fit` or `exp` object. Here we use `exp`:

```{r}
UID <- unique(smc$subjid)
cid <- UID[1]
d <- smc[smc$subjid == cid, ]
p <- predict(exp, y = d$haz, x = d$age, at = "knots")

plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Break ages, child", cid))
lines(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x, lty = 5, col = "grey80")
```

### Prediction at measurement ages, single child

Suppose we want a predicted value at each age at which the child was measured. 

```{r}
p <- predict(exp, y = d$haz, x = d$age)
```

```{r echo = FALSE}
plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Measurement ages, child", cid))
points(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = d$age, lty = 5, col = "grey80")
```


### Prediction at arbitrary ages, single child

Suppose we want the predicted value at the ages of 0.5, 14 and 17 months exactly. For this, we need to pad the observations of child `r cid` with new ages and with missing outcomes.

```{r}
age <- c(d$age, c(0.5, 14, 17)/12)
y <- c(d$haz, c(NA, NA, NA))
p <- predict(exp, y = y, x = age)
```

```{r echo = FALSE}
plot(x = d$age, y = d$haz, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Arbitrary ages, child", cid))
points(x = p$x[p$new], y = p$yhat[p$new], col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x[p$new], lty = 5, col = "grey80")
```


### Prediction of future trajectory, single child

Suppose that the child is six month old, and that we want to predict its future trajectory up to 2 years. What are the broken stick estimates at the break ages? 

```{r}
age <- d$age[1:5]
y <- d$haz[1:5]
p <- predict(exp, y = y, x = age, at = "knots")
```

```{r echo = FALSE}
plot(age, y, type = "b", col = "blue", 
     xlab = "Age (yrs)", ylab = "HAZ", main = paste("Future trajectory, child", cid), xlim = c(0,2), ylim = c(0, 1.5))
lines(x = p$x, y = p$yhat, col = "red", lwd = 1.5, lty = 2, type = "b")
abline(v = p$x, lty = 5, col = "grey80")
```

## Predict values, all children in the model

A split and loop can be used to obtain the predicted values of all children in the test data, as follows:

```{r fig.height=7, fig.width=7}
# if we have access to the brokenstick object
p <- predict(fit)
dim(p)
head(p)

# case-by-case prediction on external data, 
ds <- split(smc, f = smc$subjid, drop = TRUE)
result <- vector("list", length(ds))

for (i in seq_along(ds)) {
  d <- ds[[i]]
  if (nrow(d) > 0) result[[i]] <- predict(exp, y = d$haz, x = d$age, 
                                          output = "vector", 
                                          include.boundaries = TRUE)
}
smc$yhat <- unlist(result)
head(smc)

# do we get same answers?
all.equal(smc$yhat, p$yhat)
```

The scatterplot of the observed versus predicted values indicates an extremely accurate prediction. The correlation is to `r round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`. 

```{r}
library("MASS")
eqscplot(y = smc$yhat, x = smc$haz, ylab = "Predicted Z-score", xlab = "Observed Z-score", pch = ".", main = "Children in the model")
abline(0, 1, col = "grey")
```


## Convert to original scale

All modeling has been done in the Z-score scale. If we want the result in the original scale, we can convert the estimates using the WHO reference, as follows:

```{r}
# convert Z-score to CM
smc$yhatcm <- who_zscore2htcm(smc$agedays, smc$yhat, smc$sex)
```

The plot of the observed versus predicted is now considerably tighter, and the overall fit appears to be quite high. The correlation between the observed and predicted scores using the raw scale is equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 3)`, which is very small. 

```{r echo = FALSE}
eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Children in the model")
abline(0, 1, col = "grey")
```

## Application to holdout sample

The `smocc_hgtwgt` data has `r nrow(smocc_hgtwgt)` rows, but until now we've used only the first 2000 rows. Is prediction equally good if we apply our fitted model and exported model in `exp` to the remaining rows, that is, to observations that were not part of the model fitting?

```{r echo = FALSE}
smc <- smocc_hgtwgt[-(1:2000), ]
smc$haz <- round(who_htcm2zscore(smc$agedays, smc$htcm, smc$sex), 3)

ds <- split(smc, f = smc$subjid, drop = TRUE)
result <- vector("list", length(ds))

for (i in seq_along(ds)) {
  d <- ds[[i]]
  if (nrow(d) > 0) result[[i]] <- predict(exp, y = d$haz, x = d$age, 
                                          output = "vector", 
                                          include.boundaries = TRUE)
}
smc$yhat <- unlist(result)
```

The figure below is the scatterplot of the observed versus predicted values for the holdout sample in the Z-score scale. The correlation is to `r round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`.

```{r echo=FALSE}
eqscplot(y = smc$yhat, x = smc$haz, pch = ".", ylab = "Predicted Z-score", xlab = "Observed Z-score", main = "Holdout sample")
abline(0, 1, col = "grey")
```


```{r echo = FALSE}
# convert Z-score to CM
smc$yhatcm <- who_zscore2htcm(smc$agedays, smc$yhat, smc$sex)
```

In terms of the raw meassurement scale we find a correlation between the observed and predicted scores equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 4)`, about the size of the measurement error for height.

The plot for the holdout sample is given below.

```{r echo = FALSE}
eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Holdout sample")
abline(0, 1, col = "grey")
```

