---
title: "Untitled"
author: "Stef van Buuren"
date: "6 oktober 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## 

The scatterplot of the observed versus predicted values indicates an extremely accurate prediction. The correlation is to ` round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`.

```{r}
# library("MASS")
# eqscplot(y = smc$yhat, x = smc$haz, ylab = "Predicted Z-score", xlab = "Observed Z-score", pch = ".", main = "Children in the model")
# abline(0, 1, col = "grey")
```


## Predict from a holdout sample

The plot of the observed versus predicted is now considerably tighter, and the overall fit appears to be quite high. The correlation between the observed and predicted scores using the raw scale is equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 3)`, which is very small. 

```{r echo = FALSE}
MASS::eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Children in the model")
abline(0, 1, col = "grey")
```



## Application to holdout sample

The `smocc_hgtwgt` data has `r nrow(smocc_hgtwgt)` rows, but until now we've used only the first 2000 rows. Is prediction equally good if we apply our fitted model and exported model in `exp` to the remaining rows, that is, to observations that were not part of the model fitting?

```{r echo = FALSE}
smc <- smocc_hgtwgt[-(1:2000), ]
smc$haz <- round(who_htcm2zscore(smc$agedays, smc$htcm, smc$sex), 3)

ds <- split(smc, f = smc$subjid, drop = TRUE)
result <- vector("list", length(ds))

for (i in seq_along(ds)) {
  d <- ds[[i]]
  if (nrow(d) > 0) result[[i]] <- predict(exp, y = d$haz, x = d$age, 
                                          output = "vector", 
                                          include.boundaries = TRUE)
}
smc$yhat <- unlist(result)
```

The figure below is the scatterplot of the observed versus predicted values for the holdout sample in the Z-score scale. The correlation is to `r round(cor(smc$yhat, smc$haz, use = "complete.obs"), 4)`. The standard deviation of the residuals is equal to `r round(sd(smc$yhat - smc$haz, na.rm = TRUE), 3)`.

```{r echo=FALSE}
eqscplot(y = smc$yhat, x = smc$haz, pch = ".", ylab = "Predicted Z-score", xlab = "Observed Z-score", main = "Holdout sample")
abline(0, 1, col = "grey")
```


```{r echo = FALSE}
# convert Z-score to CM
smc$yhatcm <- who_zscore2htcm(smc$agedays, smc$yhat, smc$sex)
```

In terms of the raw meassurement scale we find a correlation between the observed and predicted scores equal to `r round(cor(smc$yhatcm, smc$htcm, use = "pairwise"), 4)`. The standard deviation of the residuals in the cm scale is equal to `r round(sd(smc$yhatcm - smc$htcm, na.rm = TRUE), 4)`, about the size of the measurement error for height.

The plot for the holdout sample is given below.

```{r echo = FALSE}
eqscplot(y = smc$yhatcm, x = smc$htcm, pch = ".", ylab = "Predicted (cm)", 
         xlab = "Observed (cm)", main = "Holdout sample")
abline(0, 1, col = "grey")
```


## Export estimates

For easy handling and storage accross sessions, the `export()` function selects from `fit` the minimal set of estimates  needed to make predictions, and stores the results in an S3 class `brokenstick.export`. 

```{r}
class(fit)
slotNames(fit)
exp <- export(fit)
names(exp)
```

