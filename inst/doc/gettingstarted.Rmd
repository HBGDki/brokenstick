---
title: "Getting started"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Overview

The *broken stick model* describes a set of individual curves by a linear mixed model using first order linear B-splines. The model can be used

- to smooth growth curves by a series of connected straight lines;
- to align irregularly observed curves to a common age grid;
- to create synthetic curves at a user-specified set of break ages;
- to estimate the time-to-time correlation matrix;
- to predict future observations.

The user specifies a set of break ages at which the straight lines connect. Each individual obtains an estimate at each break age, so the set of estimates of the individual form a smoothed version of the observed trajectory. 

The main assumptions of the broken stick model are: 

- The development between the break ages follows a straight line, and is generally not of particular interest;
- Broken stick estimates follow a common multivariate normal distribution;

In order to conform to the assumption of multivariate normality, the user may fit the broken stick model on suitably transformed data that yield the standard normal ($Z$) scale. Unique feature of the broken stick model are:

- *Modular*: Issues related to nonlinearities of the growth curves in the observed scale can be treated separately, i.e., outside the broken stick model;
- *Local*: A given data point will contribute only to the estimates corresponding to the closest break ages;
- *Exportable*: The broken stick model can be exported and reused for prediction for new data in alternative computing environments.

The `brokenstick` package contains functions for

- Fitting the broken stick model to data, 
- Exporting the parameters of the model for independent use outside this package,
- Predicting broken stick estimates for new data.

  
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 3.5)
```

## Main functions

The main functions in the `brokenstick` package are:

Function name        | Description
---------------------|---------------------------------
`brokenstick()`      | Fit a broken stick model to irregular data
`predict()`          | Predict broken stick estimates for new growth data
`export_brokenstick()` | Export broken stick model parameters 

## Exporatory analysis

```{R}
library("brokenstick")
data <- smocc_hgtwgt[1:2000,]
head(data)
```

The `smocc_hgtwgt` data in the `brokenstick` package contain the heights and weights of 1933 Dutch children measured on 10 visits at ages 0-2 years. Here we take the first 2000 records from the data, corresponding to 211 different children.

Plots of the first the height trajectories of two children can be made with the `lattice` function `xyplot()`, as follows:

```{r}
ids <- c(10001, 10005, 10022)
library(lattice)
xyplot(lencm ~ age | subjid, data = data, 
	   subset = subjid %in% ids,  
	   type = "b", pch = 19, as.table = TRUE,
	   xlab = "Age (in years)", ylab = "Length (cm)")
```

The plots gain more resolution when the Standard Deviation Scores (SDS) (or $Z$-values) are plotted. The column `hgt.z` contains the $Z$-scores of height relative to the WHO standard.

```{r}
xyplot(haz ~ age | subjid, data = data, 
	   subset = subjid %in% ids, 
	   type = "b", pch = 19, as.table = TRUE,
	   panel = function(...) {
	   	panel.refline(h = c(-2, 0, 2))
	   	panel.xyplot(...)
	   },
	   xlab = "Age (in years)", ylab = "Length (SDS)")
```


## Model fitting

### Broken stick model with two lines

The *broken stick model* attempts to describe each trajectory by a series of straight but connected lines. Let us first do a rough approximation in the above figure. We specify that we may only use two lines: One line should start at birth to the age of exactly 1 years, and another spans the period from 1 to 2 years. Moreover, we require that the lines connect at the age of 1 year. 

```{r fit1}
knots <- 0:2
fit1 <- brokenstick(y = data$haz, 
					x = data$age,
					subject = data$subjid,
					knots = knots)
```

The `knots` argument to `brokenstick()` specifies that the break ages are birth, 1 year and 2 years, respectively. The broken stick model effectively replaces the intercept by the random effects `x1`, `x2`, `x3` and `x4`, where  `x1`, `x2`, `x3` and `x4` correspond to break ages 0, 1 and 2 years, and where `x4` corresponds to a break age 2.68, a knot that is added automatically as the maximum age. This is done for technical reasons since the B-splines must encompass the entire age range in the data. The boundary knots may also be specified manually.

```{r}
class(fit1)
fit1
```

The `fit1` object has S4 class `brokenstick`. The broken stick model contains no intercept, whereas the four predictors (`x1`-`x4`) are entered both as fixed and random effects, conditional on subject (child). The ages to which they correspond can be obtained by `get_knots(fit)`.

The fixed effects correspond to the mean of population of children in the data. At birth, the children are on average 0.13 SD taller than the WHO standard. At the ages of 1 and 2 years, these estimates rise to 0.34 SD and 0.52 SD, respectively. The fact that these are positive and rising is not surprising. The Dutch are the tallest in the world, so at the age of 2 years, the Dutch are already about 0.5 SD taller than the WHO standard. Note that the estimate for `x4` (0.72), corresponding to the maximum age in the data, is just there for technical reasons. It is based on extreme extrapolation beyond the data, and should be disregarded.

The column labeled `Std.Dev.` contains the standard deviations of the random effects. These numbers are expected to be around 1, since - under the assumption that the WHO standard appropriately describes this population - the dependent variable follow a standard normal distribution with zero mean and standard deviation equal to one. The `Corr` component of the random effects lists the correlations between the broken stick estimates between the time point. Thus, the correlation between the estimates at birth (`x1`) and at 2 years (`x3`) is 0.51. The standard deviation of the residuals (within-person error) for this model is of 0.51. 

### Predicted values

The broken stick model defines predicted values as a compromise between the person's data values and the global mean. This compromise is called the *conditional mean* of the posterior distribution, it is calculated as the sum of fixed and random effects. The `predict()` function obtains predictions from the broken stick model.

In order to obtain the predicted values for each measured data point for all children in the fitted model use

```{r}
p1 <- predict(fit1)
dim(p1)
head(p1, 4)
```

The broken stick estimates can be found in the column called `yhat`. The column `new` is set to `FALSE` if `y` is actually observed. For plotting the broken stick model, we may also obtain predictions at the break ages as

```{r}
p2 <- predict(fit1, at = "knots")
head(p2, 4)
```

Since there are no observations at the break ages, the column `new` is `TRUE`. We may obtain both types of estimates for all children by 

```{r}
p <- predict(fit1, x = get_knots(fit1))
head(p, 15)
```

We may plot the original data and the broken stick estimates jointly by `xyplot()` from the `lattice` package by

```{r}
p$yhat[!p$knot] <- NA
xyplot(y + yhat ~ x | subjid, data = p, 
       subset = subjid %in% ids & x <= 2.3, 
       as.table = TRUE,
       panel = function(...) {
         panel.refline(h = c(-2, 0, 2))
         panel.refline(v = 0:2, col = "grey", lwd = 0.5, lty = 2)
         panel.superpose(...)}, 
       panel.groups = function(x, y, subscripts, groups, ..., group.number) 
         with(na.omit(data.frame(x, y)), 
              panel.lines(x, y, type = "b", pch = 20, col = group.number)),
       xlab = "Age (in years)", ylab = "Length (SDS)")
```

### Extension to nine lines

Suppose we are interest in refining the fit to the growth pattern during the first year. We add a knot for each age scheduled for a visit. This model can be run as

```{r fit2, cache = TRUE}
# 10 scheduled visits
knots <- round(c(0, 1, 2, 3, 6, 9, 12, 15, 18, 24)/12, 4)
boundary <- c(0, 3)
fit2 <- brokenstick(y = data$haz, 
					x = data$age,
					subject = data$subjid,
					knots = knots,
					boundary = boundary)
```

The `brokenstick()` function calls the `lmer()` function for model fitting. The optimization routine issues a number of warnings related to the number of random effects relative to the number of observations, and the complexity of the optimization problem. These indicate that we are asking a lot from `lmer()`, so we should be alert on any degeneracies in the estimates. 


As before, predicted values can be obtained by

```{r}
p <- predict(fit2, x = get_knots(fit_hgt))
head(p, 4)
```

```{r echo=FALSE}
p$yhat[!p$knot] <- NA
xyplot(y + yhat ~ x | subjid, data = p, 
       subset = subjid %in% ids & x <= 2.3, 
       as.table = TRUE,
       panel = function(...) {
         panel.refline(h = c(-2, 0, 2))
         panel.refline(v = knots, col = "grey", lwd = 0.5, lty = 2)
         panel.superpose(...)}, 
       panel.groups = function(x, y, subscripts, groups, ..., group.number) 
         with(na.omit(data.frame(x, y)), 
              panel.lines(x, y, type = "b", pch = 20, col = group.number)),
       xlab = "Age (in years)", ylab = "Length (SDS)")
```

The figures indicate that the model with nine lines seems to fit the data very well. More formal model assessment can be done with standard `lmer` diagnostic plots. See the vignette on *Model diagnostics* for more detail [NOTE: vignette still has to be written]. 

Some advice about knot placement: Evidently, using more knots can improve the fit to the data. However, adding an excessive number of knots will substantially increase calculation time, and create solutions that are less stable. Knot placement requires some care. Here, the knots are added at the scheduled visits, which is a reasonable strategy for obtaining good predictions. Placing knots at ages where the data are very sparse (e.g. exactly in-between visits) may result in bad predictions and should be avoided when possible. Be careful if using more knots than the (average) number of data points per person.

### Explained variance

The proportion of the variance of the outcome explained by the two-line model is

```{r}
var(fitted(fit1), na.rm = TRUE) / var(data$haz, na.rm = TRUE)
```

For the second model we get

```{r}
var(fitted(fit2), na.rm = TRUE) / var(data$haz, na.rm = TRUE)
```

so the nine-line broken stick model explains about `r round(100 * var(fitted(fit2), na.rm = TRUE) / var(data$haz, na.rm = TRUE))` percent of the variance of the height SDS.


## Publishing your model

### Export broken stick model

The `fit2` object can be stored by `save()` for future use in R. However, a more parsimonious and convenient way to reuse the model is to export its parameter estimates, and store only these. As a matter of fact, prediction using the broken stick model requires only the knot locations, the fixed effect estimates, the variance/covariance matrix of the random effects, and the size of the residual variance. The `export_brokenstick()` function will collect this information from the fitted model, and store it as a list.

```{R}
# export the broken stick models
export_hgt <- export_brokenstick(fit2)
attributes(export_hgt)
```

### Prediction using the exported model

Suppose we have four measured a new child and want to obtain predictions according to the published model stored in `export_hgt`. The following code calculates the predictions.

```{r}
# four height measurement on new child
x <- c(0, 0.32, 0.62, 1.1)
y <- c(-1.2, -1.7, -1.9, -2.1)

# prediction at ages x
atx <- predict(export_hgt, y = y, x = x)
atx
# prediction at the knots
atknots <- predict(export_hgt, y = y, x = x, at = "knots")
head(atknots)
```

The predicted values adapt to the age and height values. The figure below plots the observed data and the predicted data at the break ages.

```{r fig.width = 3, fig.align = "center", echo = FALSE}
p <- rbind(atx, atknots)
p$yhat[!p$knot] <- NA
xyplot(y + yhat ~ x, data = p, ylim = c(-3, 1),
       as.table = TRUE,
       panel = function(...) {
         panel.refline(h = c(-2, 0, 2))
         panel.refline(v = knots, col = "grey", lwd = 0.5, lty = 2)
         panel.superpose(...)}, 
       panel.groups = function(x, y, subscripts, groups, ..., group.number) 
         with(na.omit(data.frame(x, y)), 
              panel.lines(x, y, type = "b", pch = 20, col = group.number)),
       xlab = "Age (in years)", ylab = "Length (SDS)",
       main = "New person, published model")
```

See the "Fit and Predict" vignette for additional options.


